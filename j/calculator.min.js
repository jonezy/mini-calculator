/* mini-calculator 2013-06-24 */
Number.prototype.toMoney=function(a,b,c){var d=this,e="en",f=isNaN(a)?2:Math.abs(a),g=b||".",h="undefined"==typeof c?",":c,i=0>d?"-":"",j=parseInt(d=Math.abs(d).toFixed(f))+"",k=(k=j.length)>3?k%3:0;return"fr"===e&&(g=",",h=" "),i+(k?j.substr(0,k)+h:"")+j.substr(k).replace(/(\d{3})(?=\d)/g,"$1"+h)+(f?g+Math.abs(d-j).toFixed(f).slice(2):"")},Backbone.View.prototype.close=function(){return _.each(this.childViews,function(a){a.remove&&a.remove(),a.close&&a.close()}),this.off(),this.remove(),this.onClose&&this.onClose(),this};var namespace={module:function(a){return _.extend({Views:{}},a)},fetchTemplate:function(a,b){var c=this.JST=this.JST||{},d=new $.Deferred;return c[a]?(b(c[a]),d.resolve(c[a])):($.get(a,function(e){var f=_.template(e);b(c[a]=f),d.resolve(c[a])},"text"),d.promise())}},Helpers={calculateLeaseRate:function(a,b,c){var d;return _.each(a.LeaseRates,function(a){a.Term===parseInt(b)&&(d=a)}),void 0!==d?Helpers.fullCalculateLeaseRate(d.InterestRate,d.ResidualRate,b,c,d.DownPayment,20):null},fullCalculateLeaseRate:function(a,b,c,d,e,f){switch(parseInt(f)){case 12:b+=4;break;case 16:b+=3;break;case 20:b+=2;break;case 24:b+=0;break;default:b+=0}d-=e;var g=a/100,h=b/100,i=d*h,j=g/12,k=d-i,l=this.roundNumber(k/c,2),m=100*(g/2400),n=j*c,o=this.roundNumber(d,10)+this.roundNumber(i,10),p=o*m-n,q=l+p;return this.roundNumber(q,2)},calculateFinanceRate:function(a,b,c,d){c-=d;var e=a/100/12,f=c*e/(1-Math.pow(1+e,-b));return this.roundNumber(f,2)},roundNumber:function(a,b){var c=Math.round(a*Math.pow(10,b))/Math.pow(10,b);return c}},app={configuration:{domain:window.location.origin+window.location.pathname,lang:"en"}},Calculator=namespace.module();Calculator.Model=Backbone.Model.extend({defaults:function(){return{interestRate:0,residual:0,term:"40",kms:"20",price:0,downPayment:0}}}),Calculator.Collection=Backbone.Collection.extend({model:Calculator.Model}),Calculator.Views.BaseCalculatorView=Backbone.View.extend({className:"calc-wrapper modal-body",events:{"click button.term":"setTerm","click button.kms":"setKms","click button#caclulatePayment":"calculatePayment"},lookupNewTerm:function(a,b){var c,d=new Calculator.Model;_.each(this.options.data[b],function(b){b.Term===parseInt(a,10)&&(c=b)}),d.set({term:a}),d.set({interestRate:c.InterestRate}),d.set({residual:c.ResidualRate}),"en"===app.configuration.language?d.set({price:parseInt(this.options.data.Price.replace(",",""),10)}):d.set({price:parseInt(this.options.data.Price.replace(",",".").replace(" ",""),10)}),void 0!==this.model&&this.model.get("downPayment")?d.set({downPayment:this.model.get("downPayment")}):d.set({downPayment:c.DownPayment}),void 0!==this.model&&this.model.get("kms")?d.set({kms:this.model.get("kms")}):d.set({kms:20}),this.model=d},hasTerm48:function(a){var b=!1;return _.each(this.options.data[a],function(a){48===parseInt(a.Term,10)&&(b=!0)}),b},hasTerm:function(a,b){var c=!1;return _.each(this.options.data[a],function(a){parseInt(a.Term,10)===b&&(c=!0)}),c},setTerm:function(a){a.preventDefault(),srcElement=a.srcElement?a.srcElement:a.target,$srcElement=$(srcElement),newDownPayment=this.$el.find("#txtDownPmt").val(),this.model.set({downPayment:newDownPayment}),this.lookupNewTerm($srcElement.attr("data-term"),this.type),this.render()},setKms:function(a){a.preventDefault();var b=a.srcElement?a.srcElement:a.target,c=$(b);this.model.set({kms:c.attr("data-kms")}),this.render()},calculatePayment:function(a){a.preventDefault(),this.model.set({downPayment:this.$el.find("#txtDownPmt").val()}),this.render()}}),Calculator.Views.LeaseCalculator=Calculator.Views.BaseCalculatorView.extend({template:app.configuration.domain+"j/calculator-templates/lease_calc.html",initialize:function(){this.type="LeaseRates",this.lookupNewTerm("48",this.type)},render:function(){var a=this,b=Helpers.fullCalculateLeaseRate(this.model.get("interestRate"),this.model.get("residual"),this.model.get("term"),this.model.get("price"),this.model.get("downPayment"),this.model.get("kms")),c=this.model.get("price").toMoney();return namespace.fetchTemplate(this.template,function(d){a.el.innerHTML=d({data:a.model.toJSON(),payment:parseFloat(b).toMoney(),displayPrice:c,showTerm48:a.hasTerm48("LeaseRates"),showTerm39:a.hasTerm("LeaseRates",39),strings:a.options.strings,lang:app.configuration.language}),b=null,c=null}),this}}),Calculator.Views.FinanceCalculator=Calculator.Views.BaseCalculatorView.extend({template:app.configuration.domain+"j/calculator-templates/finance_calc.html",initialize:function(){this.type="FinanceRates",this.lookupNewTerm("60",this.type)},render:function(){var a=this,b=Helpers.calculateFinanceRate(this.model.get("interestRate"),this.model.get("term"),this.model.get("price"),this.model.get("downPayment"),this.model.get("kms")),c=this.model.get("price").toMoney(),d={};return d.show60=a.hasTerm("FinanceRates",39)?!0:!1,d.show60=a.hasTerm("FinanceRates",60)?!0:!1,d.show72=a.hasTerm("FinanceRates",72)?!0:!1,d.show84=a.hasTerm("FinanceRates",84)?!0:!1,namespace.fetchTemplate(this.template,function(e){a.el.innerHTML=e({data:a.model.toJSON(),payment:parseFloat(b).toMoney(),displayPrice:c,strings:a.options.strings,variableTerms:d,lang:app.configuration.language}),b=null,c=null,d=null}),this}}),Calculator.Views.Main=Backbone.View.extend({id:"calculator-window",events:{"click #show-lease":"showLeaseCalculator","click #show-finance":"showFinanceCalculator","click #addLeaseColumn":"addLeaseColumn","click #addFinanceColumn":"addFinanceColumn"},initialize:function(){this.childViews=[],this.$el.addClass("modal calculator wider"),this.options.type||(this.options.type="lease"),"object"!=typeof this.options.data&&(this.options.data=JSON.parse(this.options.data)),this.options.lang&&(app.configuration.lang=this.options.lang),this.$container=$(this.options.container),this.render()},render:function(){var a=new Calculator.Views.Header({type:this.options.type,strings:this.options.strings});a.render(),this.childViews.push(a),this.$el.html(a.el);var b=new Calculator.Views.LeaseCalculator({data:this.options.data,strings:this.options.strings}).render(),c=new Calculator.Views.FinanceCalculator({data:this.options.data,strings:this.options.strings}).render();switch(this.childViews.push(b),this.childViews.push(c),this.options.type){case"lease":this.$el.append(b.el),this.$el.append(c.el);break;case"finance":this.$el.append(c.el),this.$el.append(b.el);break;default:this.$el.append(b.el),this.$el.append(c.el)}if(this.options.thirdColumn)switch(b=new Calculator.Views.LeaseCalculator({data:this.options.data,strings:this.options.strings}).render(),c=new Calculator.Views.FinanceCalculator({data:this.options.data,strings:this.options.strings}).render(),this.options.thirdColumn){case"lease":this.$el.append(b.el);break;case"finance":this.$el.append(c.el);break;default:this.$el.append(b.el)}else this.buildAddColumn();var d=new Calculator.Views.Footer({strings:this.options.strings});return d.render(),this.childViews.push(d),this.$el.append(d.el),this},buildAddColumn:function(){var a=$('<a href="'+window.location.hash+'" id="addLeaseColumn" class="calc-link-add">'+this.options.strings.AddLeaseLinkText+"</a>"),b=$('<a href="'+window.location.hash+'" id="addFinanceColumn" class="calc-link-add">'+this.options.strings.AddFinanceLinkText+"</a>"),c=$('<div class="calc-wrapper add-column"></div>');return $(c).html(a),$(c).append(b),this.$el.append(c),this},addLeaseColumn:function(a){a.preventDefault(),this.close();var b=new Calculator.Views.Main({container:this.options.container,data:this.options.data,type:"lease",strings:this.options.strings,thirdColumn:"lease"}).render();this.$container.append(b.el)},addFinanceColumn:function(a){a.preventDefault(),this.close();var b=new Calculator.Views.Main({container:this.options.container,data:this.options.data,type:"finance",strings:this.options.strings,thirdColumn:"finance"}).render();this.$container.append(b.el)},showLeaseCalculator:function(a){a.preventDefault(),this.close();var b=new Calculator.Views.Main({container:this.options.container,type:"lease",data:this.options.data,strings:this.options.strings});this.$container.append(b.el)},showFinanceCalculator:function(a){a.preventDefault(),this.close();var b=new Calculator.Views.Main({container:this.options.container,type:"finance",data:this.options.data,strings:this.options.strings});this.$container.append(b.el)},onClose:function(){}}),Calculator.Views.Header=Backbone.View.extend({className:"modal-header",template:app.configuration.domain+"j/calculator-templates/calculator_header.html",render:function(){var a=this;return namespace.fetchTemplate(this.template,function(b){a.el.innerHTML=b({strings:a.options.strings,type:a.options.type}),a=null}),this}}),Calculator.Views.Footer=Backbone.View.extend({template:app.configuration.domain+"j/calculator-templates/calculator_footer.html",render:function(){var a=this;return namespace.fetchTemplate(this.template,function(b){a.el.innerHTML=b({strings:a.options.strings}),a=null}),this}});